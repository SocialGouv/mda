web:
  vars:
    MAILER_ENABLE: "True"
    MAILER_SMTP_HOST: maildev
    MAILER_SMTP_PORT: "1025"
    MAILER_SMTP_LOGIN: ""
    MAILER_SMTP_PASSWORD: ""
    MAILER_SMTP_SSL: "False"

strapi:
  host: "strapi-{{ .Values.global.host }}"
  addVolumes:
    - uploads
  volumeMounts:
    - mountPath: /app/apps/strapi/public/uploads
      name: uploads
  envFrom:
    - secretRef:
        name: "{{ .Values.global.pgSecretName }}"
    - secretRef:
        name: "mda-strapi"
    - secretRef:
        name: "mda-revalidate-webhook"
    - secretRef:
        name: "mda-meilisearch"
    - secretRef:
        name: "azure-mda-volume"

meilisearch:
  volume:
    - name: meilifiles
      csi:
        driver: file.csi.azure.com
        readOnly: false
        volumeAttributes:
          secretName: azure-mda-volume
          shareName: meilisearch
  volumeMounts:
    - mountPath: /meilifiles
      name: meilifiles

maildev: {}

jobs:
  runs:
    build-web:
      with:
        buildArgs:
          PRODUCTION: "true"
          NEXT_PUBLIC_STRAPI_API_URL: "https://strapi-{{ .Values.global.host }}"
    clean-meilisearch:
      volume:
        - name: meilifiles
          csi:
            driver: file.csi.azure.com
            readOnly: false
            volumeAttributes:
              secretName: azure-mda-volume
              shareName: meilisearch
      volumeMounts:
        - mountPath: /meilifiles
          name: meilifiles
      image: alpine:3
      run: |
        rm -rf /meilifiles/*
